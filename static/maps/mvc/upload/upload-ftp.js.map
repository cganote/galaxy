{"version":3,"sources":["mvc/upload/upload-ftp.js"],"names":["Backbone","View","extend","initialize","options","self","model","Model","cls","class_add","class_remove","class_partial","help_enabled","oidc_text","Galaxy","root","help_text","ftp_upload_site","collection","onchange","onadd","onremove","set","get","config","enable_oidc","setElement","_template","$content","$","$wait","$help","$number","$disk","$body","$warning","$select","render","show","hide","UploadUtils","getRemoteFiles","ftp_files","_index","_renderTable","rows","length","empty","size","_","each","push","_renderRow","ftp_file","html","Utils","bytesToString","addClass","off","on","_all","_refresh","attributes","$it","_templateRow","$icon","find","append","model_index","ftp_index","path","undefined","_switch","id","add","hasClass","index","removeClass","new_index","counts","reduce","memo","element","escape","ctime"],"mappings":"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","file":"../../../scripts/mvc/upload/upload-ftp.js","sourcesContent":["/** This renders the content of the ftp popup **/\nimport Utils from \"utils/utils\";\nimport UploadUtils from \"mvc/upload/upload-utils\";\n\nexport default Backbone.View.extend({\n    initialize: function(options) {\n        var self = this;\n        this.model = new Backbone.Model({\n            cls: \"upload-ftp\",\n            class_add: \"upload-icon-button fa fa-square-o\",\n            class_remove: \"upload-icon-button fa fa-check-square-o\",\n            class_partial: \"upload-icon-button fa fa-minus-square-o\",\n            help_enabled: true,\n            oidc_text: `<br/>If you are signed-in to Galaxy using a third-party identity and you <strong>don't have a Galaxy password</strong> please go to <a href=\"${\n                Galaxy.root\n            }user/reset_password\" target=\"_blank\">this</a> page and request a password for your Galaxy account.`,\n            help_text: `This Galaxy server allows you to upload files via FTP. To upload some files, log in to the FTP server at <strong>${\n                options.ftp_upload_site\n            }</strong> using your Galaxy credentials.\n            For help visit the <a href=\"https://galaxyproject.org/ftp-upload/\" target=\"_blank\">tutorial</a>.`,\n            collection: null,\n            onchange: function() {},\n            onadd: function() {},\n            onremove: function() {}\n        }).set(options);\n\n        this.collection = this.model.get(\"collection\");\n        if (Galaxy.config.enable_oidc) {\n            this.model.set(\"help_text\", this.model.get(\"help_text\") + this.model.get(\"oidc_text\"));\n        }\n        this.setElement(this._template());\n        this.$content = this.$(\".upload-ftp-content\");\n        this.$wait = this.$(\".upload-ftp-wait\");\n        this.$help = this.$(\".upload-ftp-help\");\n        this.$number = this.$(\".upload-ftp-number\");\n        this.$disk = this.$(\".upload-ftp-disk\");\n        this.$body = this.$(\".upload-ftp-body\");\n        this.$warning = this.$(\".upload-ftp-warning\");\n        this.$select = this.$(\".upload-ftp-select-all\");\n        this.render();\n    },\n\n    render: function() {\n        var self = this;\n        this.$wait.show();\n        this.$content.hide();\n        this.$warning.hide();\n        this.$help.hide();\n        UploadUtils.getRemoteFiles(\n            function(ftp_files) {\n                self.model.set(\"ftp_files\", ftp_files);\n                self._index();\n                self._renderTable();\n            },\n            function() {\n                self._renderTable();\n            }\n        );\n    },\n\n    /** Fill table with ftp entries */\n    _renderTable: function() {\n        var self = this;\n        var ftp_files = this.model.get(\"ftp_files\");\n        this.rows = [];\n        if (ftp_files && ftp_files.length > 0) {\n            this.$body.empty();\n            var size = 0;\n            _.each(ftp_files, ftp_file => {\n                self.rows.push(self._renderRow(ftp_file));\n                size += ftp_file.size;\n            });\n            this.$number.html(`${ftp_files.length} files`);\n            this.$disk.html(Utils.bytesToString(size, true));\n            if (this.collection) {\n                this.$(\"._has_collection\").show();\n                this.$select\n                    .addClass(this.model.get(\"class_add\"))\n                    .off()\n                    .on(\"click\", () => {\n                        self._all();\n                    });\n                this._refresh();\n            }\n            this.$content.show();\n        } else {\n            this.$warning.show();\n        }\n        this.model.get(\"help_enabled\") && this.$help.show();\n        this.$wait.hide();\n    },\n\n    /** Add row */\n    _renderRow: function(ftp_file) {\n        var self = this;\n        var options = this.model.attributes;\n        var $it = $(this._templateRow(ftp_file));\n        var $icon = $it.find(\".icon\");\n        this.$body.append($it);\n        if (this.collection) {\n            var model_index = this.ftp_index[ftp_file.path];\n            $icon.addClass(model_index === undefined ? options.class_add : options.class_remove);\n            $it.on(\"click\", () => {\n                self._switch($icon, ftp_file);\n                self._refresh();\n            });\n        } else {\n            $it.on(\"click\", () => {\n                options.onchange(ftp_file);\n            });\n        }\n        return $icon;\n    },\n\n    /** Create ftp index */\n    _index: function() {\n        var self = this;\n        this.ftp_index = {};\n        this.collection &&\n            this.collection.each(model => {\n                if (model.get(\"file_mode\") == \"ftp\") {\n                    self.ftp_index[model.get(\"file_path\")] = model.id;\n                }\n            });\n    },\n\n    /** Select all event handler */\n    _all: function() {\n        var options = this.model.attributes;\n        var ftp_files = this.model.get(\"ftp_files\");\n        var add = this.$select.hasClass(options.class_add);\n        for (var index in ftp_files) {\n            var ftp_file = ftp_files[index];\n            var model_index = this.ftp_index[ftp_file.path];\n            if ((model_index === undefined && add) || (model_index !== undefined && !add)) {\n                this._switch(this.rows[index], ftp_file);\n            }\n        }\n        this._refresh();\n    },\n\n    /** Handle collection changes */\n    _switch: function($icon, ftp_file) {\n        $icon.removeClass();\n        var options = this.model.attributes;\n        var model_index = this.ftp_index[ftp_file.path];\n        if (model_index === undefined) {\n            var new_index = options.onadd(ftp_file);\n            $icon.addClass(options.class_remove);\n            this.ftp_index[ftp_file.path] = new_index;\n        } else {\n            options.onremove(model_index);\n            $icon.addClass(options.class_add);\n            this.ftp_index[ftp_file.path] = undefined;\n        }\n    },\n\n    /** Refresh select all button state */\n    _refresh: function() {\n        var counts = _.reduce(\n            this.ftp_index,\n            (memo, element) => {\n                element !== undefined && memo++;\n                return memo;\n            },\n            0\n        );\n        this.$select.removeClass();\n        if (counts == 0) {\n            this.$select.addClass(this.model.get(\"class_add\"));\n        } else {\n            this.$select.addClass(\n                counts == this.rows.length ? this.model.get(\"class_remove\") : this.model.get(\"class_partial\")\n            );\n        }\n    },\n\n    /** Template of row */\n    _templateRow: function(options) {\n        return `<tr class=\"upload-ftp-row\"><td class=\"_has_collection\" style=\"display: none;\"><div class=\"icon\"/></td><td class=\"ftp-name\">${_.escape(\n            options.path\n        )}</td><td class=\"ftp-size\">${Utils.bytesToString(options.size)}</td><td class=\"ftp-time\">${\n            options.ctime\n        }</td></tr>`;\n    },\n\n    /** Template of main view */\n    _template: function() {\n        return `<div class=\"${this.model.get(\n            \"cls\"\n        )}\"><div class=\"upload-ftp-wait fa fa-spinner fa-spin\"/><div class=\"upload-ftp-help\">${this.model.get(\n            \"help_text\"\n        )}</div><div class=\"upload-ftp-content\"><span style=\"whitespace: nowrap; float: left;\">Available files: </span><span style=\"whitespace: nowrap; float: right;\"><span class=\"upload-icon fa fa-file-text-o\"/><span class=\"upload-ftp-number\"/>&nbsp;&nbsp;<span class=\"upload-icon fa fa-hdd-o\"/><span class=\"upload-ftp-disk\"/></span><table class=\"grid\" style=\"float: left;\"><thead><tr><th class=\"_has_collection\" style=\"display: none;\"><div class=\"upload-ftp-select-all\"></th><th>Name</th><th>Size</th><th>Created</th></tr></thead><tbody class=\"upload-ftp-body\"/></table></div><div class=\"upload-ftp-warning warningmessage\">Your FTP directory does not contain any files.</div>`;\n        (\"<div>\");\n    }\n});\n"]}